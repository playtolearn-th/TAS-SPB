<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö - TAS-SPB</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="ios-fix.js"></script>
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #ec4899;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            padding-bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { max-width: 1000px; margin: 0 auto; width: 100%; }

        /* Header */
        .header-section {
            background: white;
            width: 100%;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header-title { display: flex; align-items: center; gap: 15px; }
        .icon-box {
            width: 50px; height: 50px; background: var(--primary-color);
            color: white; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .header-text h2 { margin: 0; color: #1f2937; font-size: 1.5rem; }
        .header-text span { color: #6b7280; font-size: 0.9rem; }

        .btn-home {
            text-decoration: none; color: #4b5563; font-weight: bold;
            background: #f3f4f6; padding: 8px 16px; border-radius: 20px;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-home:hover { background: #e5e7eb; }

        /* Controls */
        .controls-card {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .date-input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 10px; font-family: 'Sarabun'; font-size: 1rem;
            background: #f9fafb;
        }

        .filter-status { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-filter {
            padding: 8px 16px; border-radius: 10px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; border: 1px solid transparent;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-filter.active { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        .search-box-container {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Tabs */
        .tabs {
            display: flex; background: #e5e7eb; padding: 5px;
            border-radius: 12px; flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            color: var(--muted); font-family: 'Sarabun'; transition: all 0.2s;
            min-width: 100px;
        }
        .tab-btn.active {
            background: var(--white); color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-section { display: none; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Items */
        .data-list { display: grid; gap: 15px; }
        .data-item {
            background: var(--white); padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-left: 5px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .data-item.pressing {
            transform: scale(0.97);
            background-color: #fefce8;
        }

        .data-item.captured {
            animation: flash 0.5s;
        }

        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; background-color: #fff; }
            100% { opacity: 1; }
        }

        .item-att { border-left-color: var(--primary-color); }
        .item-leave { border-left-color: var(--warning); }
        .item-personnel { border-left-color: var(--info); }

        .info h4 { margin: 0; font-size: 1rem; }
        .info p {
            margin: 5px 0 0; font-size: 0.85rem; color: var(--muted);
            display: flex; gap: 8px; flex-wrap: wrap;
        }

        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-red { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-orange { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .bg-blue { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        .actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 36px; height: 36px; border-radius: 8px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-edit { background: #fffbeb; color: #d97706; }
        .btn-del { background: #fef2f2; color: #dc2626; }

        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-top: 20px; padding: 10px;
        }
        .btn-page {
            padding: 8px 16px; border-radius: 12px; border: none;
            background: white; color: var(--text); font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex; align-items: center; gap: 5px;
        }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }

        .fab {
            position: fixed; bottom: 20px; right: 20px; background: var(--success);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            cursor: pointer; border: none; z-index: 100;
        }

        @media (max-width: 600px) {
            .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn-home { align-self: flex-start; }
            .data-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .actions { width: 100%; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }
            .search-box-container { flex-direction: column; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-section">
            <div class="header-title">
                <div class="icon-box"><i class="fas fa-calendar-check"></i></div>
                <div class="header-text">
                    <h2 id="pageTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <span id="pageSubTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</span>
                </div>
            </div>
            <a href="menu.html" class="btn-home">
                <i class="fas fa-home"></i> ‡πÄ‡∏°‡∏ô‡∏π
            </a>
        </div>

        <div class="controls-card">
            <div id="date-control-group">
                <label style="font-weight:bold; color:#6b7280;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate" class="date-input" onchange="loadAttendance()">
            </div>
            <div class="tabs">
                <button id="btn-tab-att" class="tab-btn active" onclick="switchTab('att')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                <button id="btn-tab-leave" class="tab-btn" onclick="switchTab('leave')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                <button id="btn-tab-personnel" class="tab-btn" onclick="switchTab('personnel')" style="display:none;">üë• ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
            </div>
        </div>

        <div id="tab-att" class="content-section active">
            <div id="filter-container" class="filter-status" style="display:none;">
                <button id="filter-all" class="btn-filter bg-green active" onclick="setStatusFilter('all')">
                    <i class="fas fa-list"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button id="filter-incomplete" class="btn-filter bg-gray" onclick="setStatusFilter('incomplete')">
                    <i class="fas fa-exclamation-triangle"></i> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                </button>
            </div>
            <div id="list-att" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="tab-leave" class="content-section">
            <div class="search-box-container">
                <div style="flex: 2; min-width: 200px;">
                    <input type="text" id="leave-search-name" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="if(event.key==='Enter') searchLeave()">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <input type="date" id="leave-search-date" class="date-input">
                </div>
                <button class="btn-filter bg-green" onclick="searchLeave()" style="color: #166534; background-color: #dcfce7; border: 1px solid #bbf7d0;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearLeaveFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-leave" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="leave-prev-btn" class="btn-page" onclick="changeLeavePage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="leave-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="leave-next-btn" class="btn-page" onclick="changeLeavePage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="tab-personnel" class="content-section">
            <div class="search-box-container">
                <div style="flex: 1;">
                    <input type="text" id="personnel-search" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." onkeyup="if(event.key==='Enter') searchPersonnel()">
                </div>
                <button class="btn-filter bg-blue" onclick="searchPersonnel()" style="color: #1e40af; background-color: #dbeafe; border: 1px solid #bfdbfe;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearPersonnelFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-personnel" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="personnel-prev-btn" class="btn-page" onclick="changePersonnelPage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="personnel-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="personnel-next-btn" class="btn-page" onclick="changePersonnelPage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <button class="fab" onclick="handleAddClick()"><i class="fas fa-plus"></i></button>

    <script>
        const storedUser = localStorage.getItem('tas_user');
        if (!storedUser) { window.location.href = 'login.html'; }

        const user = JSON.parse(storedUser);
        const userLevel = String(user.level || '').trim();

        if (userLevel !== '1' && userLevel !== '2') {
            document.body.style.display = 'none';
            setTimeout(() => {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ',
                    text: `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ`,
                    confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π'
                }).then(() => { window.location.replace('menu.html'); });
            }, 100);
            throw new Error("Unauthorized Access");
        }

        if (typeof sbClient === 'undefined') Swal.fire('Error', 'Supabase Client Not Found', 'error');

        let currentTab = 'att';
        let statusFilter = 'all';
        let personnelMap = {};
        let leaveTypes = [];

        let leavePage = 0;
        const LEAVE_PER_PAGE = 10;
        let personnelPage = 0;
        const PERSONNEL_PER_PAGE = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            const dateInput = document.getElementById('filterDate');
            if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            
            await loadMasterData();

            if (userLevel === '2') {
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£"; 
                document.getElementById('btn-tab-att').style.display = 'none';
                document.getElementById('btn-tab-personnel').style.display = 'block';
                switchTab('leave');
            } else {
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£";
                document.getElementById('btn-tab-personnel').style.display = 'block';
                loadAttendance();
            }
        });

        window.switchTab = function (tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-tab-${tabName}`);
            if (btn) btn.classList.add('active');

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            const dateControl = document.getElementById('date-control-group');
            document.getElementById('filter-container').style.display = 'none';
            
            if (tabName === 'att') {
                if (dateControl) dateControl.style.display = 'block';
                loadAttendance();
            } else if (tabName === 'leave') {
                if (dateControl) dateControl.style.display = 'none';
                loadLeaves();
            } else if (tabName === 'personnel') {
                if (dateControl) dateControl.style.display = 'none';
                loadPersonnel();
            }
        }

        async function loadMasterData() {
            try {
                const { data: users } = await sbClient.from('Personnel').select('personnel_id, name');
                if (users) users.forEach(u => personnelMap[u.personnel_id] = u.name);
                const { data: settings } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('value').eq('key', 'leave_types').single();
                leaveTypes = (settings && settings.value) ? settings.value.split(',') : ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
            } catch (e) { console.error(e); }
        }

        // --- Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (html2canvas) ---
        function attachLongPress(containerId) {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.data-item');
            items.forEach(item => {
                let pressTimer;
                const startPress = (e) => {
                    if (e.target.closest('button')) return;
                    item.classList.add('pressing');
                    pressTimer = setTimeout(() => {
                        item.classList.remove('pressing');
                        item.classList.add('captured');
                        setTimeout(() => item.classList.remove('captured'), 500);
                        if (navigator.vibrate) navigator.vibrate(100);
                        captureAndShare(item);
                    }, 1500);
                };
                const cancelPress = () => { clearTimeout(pressTimer); item.classList.remove('pressing'); };
                item.addEventListener('mousedown', startPress);
                item.addEventListener('mouseup', cancelPress);
                item.addEventListener('mouseleave', cancelPress);
                item.addEventListener('touchstart', startPress, { passive: true });
                item.addEventListener('touchend', cancelPress);
            });
        }

        async function captureAndShare(element) {
            Swal.fire({ text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => { Swal.showLoading(); } });
            try {
                const actionsDiv = element.querySelector('.actions');
                if(actionsDiv) actionsDiv.style.visibility = 'hidden';
                const canvas = await html2canvas(element, { backgroundColor: '#ffffff', scale: 3, useCORS: true });
                if(actionsDiv) actionsDiv.style.visibility = 'visible';
                const dataUrl = canvas.toDataURL('image/png');
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                Swal.fire({
                    imageUrl: dataUrl,
                    confirmButtonText: '<i class="fas fa-share-alt"></i>',
                    confirmButtonColor: '#007aff',
                    showDenyButton: !isMobile,
                    denyButtonText: '<i class="fas fa-download"></i>',
                    denyButtonColor: '#10b981',
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const blob = await (await fetch(dataUrl)).blob();
                        const file = new File([blob], "tas-card.png", { type: blob.type });
                        if (navigator.share) await navigator.share({ files: [file] });
                    } else if (result.isDenied) {
                        const link = document.createElement('a');
                        link.download = `tas-card-${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                    }
                });
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
        }

        // ==========================================
        // Attendance
        // ==========================================
        window.setStatusFilter = function (status) {
            statusFilter = status;
            loadAttendance();
        }

        async function loadAttendance() {
            if (userLevel !== '1') return;
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('list-att');
            container.innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
            try {
                let query = sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', date);
                if (statusFilter === 'incomplete') query = query.or('time_in.is.null,time_out.is.null');
                const { data } = await query.order('time_in');
                if (!data || data.length === 0) { container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; return; }
                container.innerHTML = data.map(r => `
                    <div class="data-item item-att">
                        <div class="info">
                            <h4>${r.full_name || personnelMap[r.personnel_id] || r.personnel_id}</h4>
                            <p>
                                <span class="badge ${r.time_in ? 'bg-green' : 'bg-red'}">‡πÄ‡∏Ç‡πâ‡∏≤: ${r.time_in ? r.time_in.slice(0, 5) : '‡∏Ç‡∏≤‡∏î'}</span>
                                <span class="badge ${r.time_out ? 'bg-green' : 'bg-red'}">‡∏≠‡∏≠‡∏Å: ${r.time_out ? r.time_out.slice(0, 5) : '‡∏Ç‡∏≤‡∏î'}</span>
                            </p>
                        </div>
                        <div class="actions">
                            <button class="btn-icon btn-edit" onclick="editAtt('${r.id}', '${r.full_name}', '${r.time_in || ''}', '${r.time_out || ''}')"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon btn-del" onclick="delAtt('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
                attachLongPress('list-att');
            } catch (err) { container.innerHTML = `<div style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }

        // ==========================================
        // Leaves (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤)
        // ==========================================
        function searchLeave() { leavePage = 0; loadLeaves(); }
        function clearLeaveFilter() {
            document.getElementById('leave-search-name').value = '';
            document.getElementById('leave-search-date').value = '';
            leavePage = 0; loadLeaves();
        }
        async function loadLeaves() {
            const container = document.getElementById('list-leave');
            const pageNumDisplay = document.getElementById('leave-page-num');
            const nameSearch = document.getElementById('leave-search-name').value.trim().toLowerCase();
            const dateSearch = document.getElementById('leave-search-date').value;
            const start = leavePage * LEAVE_PER_PAGE;
            const end = start + LEAVE_PER_PAGE - 1;

            try {
                let query = sbClient.from('Leave_records').select('*').neq('leave_type', '‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô');
                if (dateSearch) query = query.eq('leave_date', dateSearch);
                if (nameSearch) {
                    const matchingIds = Object.keys(personnelMap).filter(id => (personnelMap[id] || '').toLowerCase().includes(nameSearch) || id.includes(nameSearch));
                    query = query.in('personnel_id', matchingIds.length > 0 ? matchingIds : ['none']);
                }
                const { data } = await query.order('leave_date', { ascending: false }).range(start, end);
                if (!data || data.length === 0) { container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; return; }
                container.innerHTML = data.map(r => `
                    <div class="data-item item-leave">
                        <div class="info">
                            <h4>${personnelMap[r.personnel_id] || r.personnel_id}</h4>
                            <p><span class="badge bg-orange">${r.leave_type}</span><span style="color:#333; font-weight:bold;">${formatThaiDate(r.leave_date)}</span></p>
                        </div>
                        <div class="actions">
                            <button class="btn-icon btn-edit" onclick="openLeaveModal('${r.id}', '${r.personnel_id}', '${r.leave_type}')"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon btn-del" onclick="delLeave('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
                attachLongPress('list-leave');
                pageNumDisplay.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${leavePage + 1}`;
                document.getElementById('leave-next-btn').disabled = data.length < LEAVE_PER_PAGE;
                document.getElementById('leave-prev-btn').disabled = leavePage === 0;
            } catch (err) { console.error(err); }
        }

        window.changeLeavePage = function (delta) { leavePage += delta; loadLeaves(); }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ---
        async function getAbsentPersonnel(date) {
            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const { data: allP } = await sbClient.from('Personnel').select('personnel_id, name').order('name');
                // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                const { data: att } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('personnel_id').eq('work_date', date);
                // 3. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                const { data: leave } = await sbClient.from('Leave_records').select('personnel_id').eq('leave_date', date);

                const activeIds = new Set([
                    ...(att || []).map(a => a.personnel_id),
                    ...(leave || []).map(l => l.personnel_id)
                ]);

                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≤
                return allP.filter(p => !activeIds.has(p.personnel_id));
            } catch (e) { return []; }
        }

        async function openLeaveModal(id = null, pid = '', type = '') {
            const isEdit = !!id;
            const today = new Date().toISOString().split('T')[0];
            const typeOpts = leaveTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('');

            let nameSelectHtml = '';
            if (!isEdit) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const absentList = await getAbsentPersonnel(today);
                Swal.close();

                if (absentList.length === 0) {
                    Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'info');
                    return;
                }

                const options = absentList.map(p => `<option value="${p.personnel_id}">${p.name} (${p.personnel_id})</option>`).join('');
                nameSelectHtml = `
                    <div style="margin-bottom:10px;">
                        <label style="font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏≤:</label>
                        <select id="l-pid" class="date-input">${options}</select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤:</label>
                        <input type="date" id="l-date" class="date-input" value="${today}">
                    </div>`;
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô)
                nameSelectHtml = `
                    <div style="margin-bottom:10px;">
                        <label style="font-weight:bold;">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                        <input class="date-input" value="${personnelMap[pid] || pid}" readonly style="background:#f3f4f6">
                        <input type="hidden" id="l-pid" value="${pid}">
                    </div>`;
            }

            const { value: f } = await Swal.fire({
                title: isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏•‡∏≤' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤',
                html: `
                    <div class="modal-form" style="text-align:left;">
                        ${nameSelectHtml}
                        <div>
                            <label style="font-weight:bold;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤:</label>
                            <select id="l-type" class="date-input">${typeOpts}</select>
                        </div>
                    </div>`,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                preConfirm: () => ({
                    pid: document.getElementById('l-pid').value,
                    type: document.getElementById('l-type').value,
                    date: isEdit ? null : document.getElementById('l-date').value
                })
            });

            if (f && f.pid) {
                const pl = { personnel_id: f.pid, leave_type: f.type, status: 'approved' };
                if (!isEdit) {
                    pl.id = Date.now();
                    pl.leave_date = f.date;
                    await sbClient.from('Leave_records').insert([pl]);
                } else {
                    await sbClient.from('Leave_records').update(pl).eq('id', id);
                }
                loadLeaves();
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // ==========================================
        // Personnel
        // ==========================================
        async function loadPersonnel() {
            const container = document.getElementById('list-personnel');
            const searchVal = document.getElementById('personnel-search').value.trim();
            const start = personnelPage * PERSONNEL_PER_PAGE;
            const end = start + PERSONNEL_PER_PAGE - 1;

            try {
                let query = sbClient.from('Personnel').select('*');
                if (searchVal) query = query.or(`name.ilike.%${searchVal}%,personnel_id.ilike.%${searchVal}%`);
                const { data } = await query.order('personnel_id').range(start, end);
                if (!data) return;
                container.innerHTML = data.map(p => `
                    <div class="data-item item-personnel">
                        <div class="info">
                            <h4>${p.name}</h4>
                            <p><span class="badge bg-blue">ID: ${p.personnel_id}</span><span class="badge bg-gray">${p.personnel_type || '-'}</span></p>
                        </div>
                        ${userLevel === '1' ? `<div class="actions">
                            <button class="btn-icon btn-edit" onclick='openPersonnelModal(${JSON.stringify(p)})'><i class="fas fa-pen"></i></button>
                            <button class="btn-icon btn-del" onclick="deletePersonnel('${p.personnel_id}', '${p.name}')"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>`).join('');
                attachLongPress('list-personnel');
                document.getElementById('personnel-page-num').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${personnelPage + 1}`;
                document.getElementById('personnel-next-btn').disabled = data.length < PERSONNEL_PER_PAGE;
                document.getElementById('personnel-prev-btn').disabled = personnelPage === 0;
            } catch (e) { console.error(e); }
        }

        window.changePersonnelPage = function (delta) { personnelPage += delta; loadPersonnel(); }
        window.searchPersonnel = function() { personnelPage = 0; loadPersonnel(); }
        window.clearPersonnelFilter = function() { document.getElementById('personnel-search').value = ''; personnelPage = 0; loadPersonnel(); }

        // --- Modals ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Personnel/Attendance) ---
        async function openPersonnelModal(data = null) {
            const isEdit = !!data;
            const { value: f } = await Swal.fire({
                title: isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£',
                html: `
                    <div class="modal-form" style="text-align:left;">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label><input id="p-id" class="date-input" value="${data?data.personnel_id:''}" ${isEdit?'readonly':''}>
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label><input id="p-name" class="date-input" value="${data?data.name:''}">
                        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</label><input id="p-type" class="date-input" value="${data?data.personnel_type||'':''}">
                    </div>`,
                showCancelButton: true,
                preConfirm: () => ({ id: document.getElementById('p-id').value, name: document.getElementById('p-name').value, type: document.getElementById('p-type').value })
            });
            if (f) {
                if (isEdit) await sbClient.from('Personnel').update({ name: f.name, personnel_type: f.type }).eq('personnel_id', f.id);
                else await sbClient.from('Personnel').insert([{ personnel_id: f.id, name: f.name, personnel_type: f.type }]);
                loadPersonnel();
            }
        }

        window.handleAddClick = function () {
            if (currentTab === 'att') openAttModal();
            else if (currentTab === 'leave') openLeaveModal();
            else if (currentTab === 'personnel') openPersonnelModal();
        }

        async function openAttModal() {
            const date = document.getElementById('filterDate').value;
            const { value: f } = await Swal.fire({
                title: '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
                html: `<input id="s-pid" class="date-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..."><div id="s-res" style="max-height:150px; overflow-y:auto;"></div><input type="hidden" id="a-pid"><input type="time" id="a-time" class="date-input" value="${new Date().toTimeString().slice(0,5)}"><select id="a-type" class="date-input"><option value="in">‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="out">‡∏≠‡∏≠‡∏Å</option></select>`,
                didOpen: () => setupSearch('s-pid', 's-res', 'a-pid'),
                preConfirm: () => ({ pid: document.getElementById('a-pid').value, time: document.getElementById('a-time').value, type: document.getElementById('a-type').value })
            });
            if (f && f.pid) {
                const { data: ex } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('personnel_id', f.pid).eq('work_date', date).maybeSingle();
                if (ex) await sbClient.from(TAS_CONFIG.TABLE_TARGET).update(f.type === 'in' ? { time_in: f.time } : { time_out: f.time }).eq('id', ex.id);
                else await sbClient.from(TAS_CONFIG.TABLE_TARGET).insert([{ id: Date.now().toString(), personnel_id: f.pid, full_name: personnelMap[f.pid], work_date: date, [f.type === 'in' ? 'time_in' : 'time_out']: f.time }]);
                loadAttendance();
            }
        }

        function setupSearch(inpId, resId, pidId) {
            const inp = document.getElementById(inpId), res = document.getElementById(resId);
            inp.addEventListener('input', async (e) => {
                const kw = e.target.value.trim();
                if (kw.length < 1) { res.innerHTML = ''; return; }
                const { data } = await sbClient.from('Personnel').select('personnel_id, name').ilike('name', `%${kw}%`).limit(5);
                res.innerHTML = (data || []).map(p => `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="document.getElementById('${pidId}').value='${p.personnel_id}'; document.getElementById('${inpId}').value='${p.name}'; document.getElementById('${resId}').innerHTML='';">${p.name}</div>`).join('');
            });
        }

        function formatThaiDate(d) { return new Date(d).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'2-digit' }); }
        async function delAtt(id) { if ((await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', showCancelButton: true })).isConfirmed) { await sbClient.from(TAS_CONFIG.TABLE_TARGET).delete().eq('id', id); loadAttendance(); } }
        async function delLeave(id) { if ((await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', showCancelButton: true })).isConfirmed) { await sbClient.from('Leave_records').delete().eq('id', id); loadLeaves(); } }
        async function deletePersonnel(id) { if ((await Swal.fire({ title: '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?', showCancelButton: true })).isConfirmed) { await sbClient.from('Personnel').delete().eq('personnel_id', id); loadPersonnel(); } }
        async function editAtt(id, name, tin, tout) {
            const { value: f } = await Swal.fire({ title: name, html: `<input type="time" id="e-in" class="date-input" value="${tin}"><input type="time" id="e-out" class="date-input" value="${tout}">`, preConfirm: () => ({ in: document.getElementById('e-in').value, out: document.getElementById('e-out').value }) });
            if (f) { await sbClient.from(TAS_CONFIG.TABLE_TARGET).update({ time_in: f.in || null, time_out: f.out || null }).eq('id', id); loadAttendance(); }
        }
    </script>
</body>
</html>
