<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <style>
        :root {
            --primary: #ec4899;
            --bg: #f3f4f6;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            border-bottom: 4px solid var(--primary);
            flex-shrink: 0;
        }

        .tabs {
            display: flex;
            background: #fdf2f8;
            padding: 5px;
            border-radius: 15px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            color: var(--muted);
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .sub-filter-area {
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .sub-tabs {
            display: flex;
            gap: 5px;
            background: #fff;
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow-x: auto;
            /* Allow scroll on small screens */
        }

        .sub-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--muted);
            white-space: nowrap;
        }

        .sub-btn.active {
            background: var(--primary);
            color: white;
        }

        .content-scroll {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .content-section {
            display: flex;
            flex-direction: column;
        }

        .data-list {
            display: grid;
            gap: 8px;
            align-content: start;
        }

        .data-item {
            background: white;
            padding: 12px;
            border-radius: 15px;
            border-left: 5px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            height: 85px;
        }

        .item-att {
            border-left-color: var(--primary);
        }

        .item-leave {
            border-left-color: #f59e0b;
        }

        .item-person {
            border-left-color: #6b7280;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .bg-green {
            background: #dcfce7;
            color: #166534;
        }

        .bg-red {
            background: #fee2e2;
            color: #991b1b;
        }

        .date-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'Sarabun';
            margin-bottom: 10px;
            font-size: 1rem;
            text-align: center;
            color: var(--text);
        }

        /* Search Suggestion Styling */
        .suggestion-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
        }

        .suggestion-item:hover {
            background-color: #fdf2f8;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 25px;
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 8px 15px rgba(236, 72, 153, 0.4);
            transition: 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <div class="container" id="app-container" style="display: none;">
        <div class="card-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-size:1.1rem;"><i class="fas fa-user-cog"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ TAS-SPB</h2>
                <a href="menu.html" style="color:var(--primary);"><i class="fas fa-home fa-lg"></i></a>
            </div>
        </div>

        <div class="tabs" id="main-tabs"></div>

        <div class="content-scroll" id="main-content">
            <div id="section-att" class="content-section" style="display:none;">
                <div class="sub-filter-area">
                    <input type="date" id="attDate" class="date-input" onchange="render()">
                    <div class="sub-tabs">
                        <button class="sub-btn active" id="att-sub-comp" onclick="setAttSub('comp')">‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</button>
                        <button class="sub-btn" id="att-sub-inc" onclick="setAttSub('inc')">‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</button>
                    </div>
                </div>
                <div id="list-att" class="data-list"></div>
            </div>

            <div id="section-leave" class="content-section" style="display:none;">
                <div class="sub-filter-area">
                    <div class="sub-tabs">
                        <button class="sub-btn active" id="leave-sub-all"
                            onclick="setLeaveSub('all')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                        <button class="sub-btn" id="leave-sub-date" onclick="setLeaveSub('date')">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</button>
                        <button class="sub-btn" id="leave-sub-name" onclick="setLeaveSub('name')">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
                    </div>

                    <!-- Date Input -->
                    <div id="leave-date-input-area" style="display:none; margin-top:10px;">
                        <input type="date" id="leaveDate" class="date-input" onchange="render()">
                    </div>

                    <!-- Name Search Input -->
                    <div id="leave-name-input-area" style="display:none; margin-top:10px; position:relative;">
                        <input type="text" id="leaveSearchName" class="date-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                            autocomplete="off" style="text-align:left; padding-left:15px;">
                        <div id="leaveNameSuggestions"
                            style="position:absolute; top:50px; left:0; right:0; background:white; border:1px solid #e5e7eb; border-radius:12px; max-height:200px; overflow-y:auto; z-index:100; display:none; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
                <div id="list-leave" class="data-list"></div>
            </div>

            <div id="section-person" class="content-section" style="display:none;">
                <div id="list-person" class="data-list"></div>
            </div>
        </div>
    </div>

    <button class="fab" id="fab-add" style="display: none;" onclick="handleAdd()">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        let userData = {};
        let currentTab = '';
        let filters = { att: 'comp', leave: 'all', leavePersonId: null };
        let personnelList = [];
        let personnelMap = {};
        let leaveTypes = [];

        function fmtThai(d) {
            if (!d) return '-';
            const date = new Date(d);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        const checkAccess = () => {
            userData = JSON.parse(localStorage.getItem('tas_user') || '{}');
            const level = String(userData.level || '');
            if (level !== '1' && level !== '2') { window.location.replace('menu.html'); return false; }
            const tabsHtml = [];
            if (level === '1') tabsHtml.push('<button id="tab-att-btn" class="tab-btn" onclick="changeMainTab(\'att\')">üïí ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>');
            tabsHtml.push('<button id="tab-leave-btn" class="tab-btn" onclick="changeMainTab(\'leave\')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>');
            tabsHtml.push('<button id="tab-person-btn" class="tab-btn" onclick="changeMainTab(\'person\')">üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>');
            document.getElementById('main-tabs').innerHTML = tabsHtml.join('');
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('fab-add').style.display = 'flex';
            changeMainTab(level === '1' ? 'att' : 'leave');
            return true;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAccess()) return;
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('attDate')) document.getElementById('attDate').value = today;
            document.getElementById('leaveDate').value = today;
            await loadMasterData();
            setupLeaveSearch();
            render();
        });

        async function loadMasterData() {
            const { data: pData } = await sbClient.from('Personnel').select('*').order('name');
            personnelList = pData || [];
            personnelList.forEach(p => personnelMap[p.personnel_id] = p.name);
            const { data: sData } = await sbClient.from('Settings').select('value').eq('key', 'leave_types').single();
            leaveTypes = sData?.value ? sData.value.split(',').map(t => t.trim()) : ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô'];
        }

        // Setup Name Search
        function setupLeaveSearch() {
            const input = document.getElementById('leaveSearchName');
            const box = document.getElementById('leaveNameSuggestions');

            input.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                if (!val) {
                    box.style.display = 'none';
                    return;
                }

                const matches = personnelList.filter(p => p.name.toLowerCase().includes(val));
                if (matches.length > 0) {
                    box.innerHTML = matches.map(p => `
                        <div class="suggestion-item" onclick="selectLeavePerson('${p.personnel_id}', '${p.name}')">
                            <div style="font-weight:bold; color:#374151;">${p.name}</div>
                            <div style="font-size:0.8rem; color:#9ca3af;">‡∏£‡∏´‡∏±‡∏™: ${p.personnel_id}</div>
                        </div>
                    `).join('');
                    box.style.display = 'block';
                } else {
                    box.innerHTML = '<div style="padding:10px; color:#9ca3af; text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>';
                    box.style.display = 'block';
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !box.contains(e.target)) {
                    box.style.display = 'none';
                }
            });
        }

        function selectLeavePerson(id, name) {
            filters.leavePersonId = id;
            document.getElementById('leaveSearchName').value = name;
            document.getElementById('leaveNameSuggestions').style.display = 'none';
            render();
        }

        function changeMainTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}-btn`));
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${t}`).style.display = 'flex';
            render();
        }

        function setAttSub(s) { filters.att = s; document.getElementById('att-sub-comp').classList.toggle('active', s === 'comp'); document.getElementById('att-sub-inc').classList.toggle('active', s === 'inc'); render(); }

        function setLeaveSub(s) {
            filters.leave = s;
            document.getElementById('leave-sub-all').classList.toggle('active', s === 'all');
            document.getElementById('leave-sub-date').classList.toggle('active', s === 'date');
            document.getElementById('leave-sub-name').classList.toggle('active', s === 'name');

            document.getElementById('leave-date-input-area').style.display = s === 'date' ? 'block' : 'none';
            document.getElementById('leave-name-input-area').style.display = s === 'name' ? 'block' : 'none';

            if (s === 'name' && !filters.leavePersonId) {
                document.getElementById('list-leave').innerHTML = '<center style="padding:40px; color:#9ca3af;"><i class="fas fa-search fa-2x"></i><br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</center>';
            } else {
                render();
            }
        }

        async function render() {
            if (currentTab === 'att') await renderAtt();
            else if (currentTab === 'leave') await renderLeave();
            else await renderPerson();
        }

        async function renderAtt() {
            const date = document.getElementById('attDate').value;
            let q = sbClient.from('TimeStamp').select('*').eq('work_date', date);
            if (filters.att === 'comp') q = q.not('time_in', 'is', null).not('time_out', 'is', null);
            else q = q.or('time_in.is.null,time_out.is.null');
            const { data } = await q.order('time_in', { ascending: true });
            document.getElementById('list-att').innerHTML = data?.map(r => `
            <div class="data-item item-att">
                <div style="flex:1">
                    <strong>${personnelMap[r.personnel_id] || r.full_name}</strong><br>
                    <small>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fmtThai(r.work_date)}</small>
                    <div style="margin-top:4px;">
                        <span class="badge ${r.time_in ? 'bg-green' : 'bg-red'}">IN: ${r.time_in?.slice(0, 5) || '--:--'}</span>
                        <span class="badge ${r.time_out ? 'bg-green' : 'bg-red'}">OUT: ${r.time_out?.slice(0, 5) || '--:--'}</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn-icon" onclick="editAtt('${r.id}','${r.time_in}','${r.time_out}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('TimeStamp','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('') || '<center style="padding:20px; color:#9ca3af;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>';
        }

        async function renderLeave() {
            let q = sbClient.from('Leave_records').select('*');

            if (filters.leave === 'date') {
                q = q.eq('leave_date', document.getElementById('leaveDate').value);
            } else if (filters.leave === 'name') {
                if (!filters.leavePersonId) return; // Don't query if no person selected yet
                q = q.eq('personnel_id', filters.leavePersonId);
            }

            const { data } = await q.order('leave_date', { ascending: false });

            if (!data || data.length === 0) {
                document.getElementById('list-leave').innerHTML = '<center style="padding:20px; color:#9ca3af;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</center>';
                return;
            }

            document.getElementById('list-leave').innerHTML = data.map(r => `
            <div class="data-item item-leave">
                <div style="flex:1">
                    <small style="color:var(--primary); font-weight:bold;">üìÖ ${fmtThai(r.leave_date)}</small><br>
                    <strong>${personnelMap[r.personnel_id] || r.personnel_id}</strong><br>
                    <span class="badge" style="background:#fff7ed; color:#c2410c;">${r.leave_type}</span>
                </div>
                <div class="actions">
                    <button class="btn-icon" onclick="editLeave('${r.id}','${r.leave_date}','${r.leave_type}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Leave_records','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('');
        }

        async function renderPerson() {
            const { data } = await sbClient.from('Personnel').select('*').order('personnel_id');
            const isAdmin = userData.level == 1;
            document.getElementById('list-person').innerHTML = data?.map(p => `
            <div class="data-item item-person">
                <div style="flex:1">
                    <strong>${p.name}</strong><br>
                    <small>‡∏£‡∏´‡∏±‡∏™: ${p.personnel_id}</small><br>
                    <small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: ${fmtThai(p.start_date)}</small>
                </div>
                <div class="actions" style="${isAdmin ? '' : 'display:none'}">
                    <button class="btn-icon" onclick="editPerson('${p.personnel_id}','${p.name}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Personnel','${p.personnel_id}','personnel_id')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('') || '<center style="padding:20px; color:#9ca3af;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</center>';
        }

        async function delRec(tbl, id, col = 'id') { if ((await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' })).isConfirmed) { await sbClient.from(tbl).delete().eq(col, id); render(); } }
        async function editAtt(id, tin, tout) { const { value: f } = await Swal.fire({ title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤', html: `‡πÄ‡∏Ç‡πâ‡∏≤: <input id="sw-in" type="time" class="swal2-input" value="${tin?.slice(0, 5) || ''}"> ‡∏≠‡∏≠‡∏Å: <input id="sw-out" type="time" class="swal2-input" value="${tout?.slice(0, 5) || ''}">`, preConfirm: () => ({ time_in: document.getElementById('sw-in').value || null, time_out: document.getElementById('sw-out').value || null }) }); if (f) { await sbClient.from('TimeStamp').update(f).eq('id', id); render(); } }
        async function editLeave(id, date, type) { const { value: f } = await Swal.fire({ title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏•‡∏≤', html: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <input id="sw-date" type="date" class="swal2-input" value="${date}"> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <select id="sw-type" class="swal2-input">${leaveTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('')}</select>`, preConfirm: () => ({ leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value }) }); if (f) { await sbClient.from('Leave_records').update(f).eq('id', id); render(); } }
        async function editPerson(id, name) { const { value: n } = await Swal.fire({ title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠', input: 'text', inputValue: name }); if (n) { await sbClient.from('Personnel').update({ name: n }).eq('personnel_id', id); await loadMasterData(); render(); } }

        async function handleAdd() {
            if (currentTab === 'person') {
                const { value: f } = await Swal.fire({
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà',
                    html: `<input id="sw-pid" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£" class="swal2-input"><input id="sw-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="swal2-input"><div style="text-align:left; padding:0 20px;"><small>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</small></div><input id="sw-start" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">`,
                    preConfirm: () => ({ personnel_id: document.getElementById('sw-pid').value, name: document.getElementById('sw-name').value, start_date: document.getElementById('sw-start').value, level: 3 })
                });
                if (f?.personnel_id) { await sbClient.from('Personnel').insert([f]); await loadMasterData(); render(); }
            } else if (currentTab === 'leave') {
                let selectedDate = new Date().toISOString().split('T')[0];

                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                const getAbsentList = async (targetDate) => {
                    const { data: allP } = await sbClient.from('Personnel').select('personnel_id, name');
                    const { data: att } = await sbClient.from('TimeStamp').select('personnel_id').eq('work_date', targetDate);
                    const { data: lve } = await sbClient.from('Leave_records').select('personnel_id').eq('leave_date', targetDate);

                    if (!att || att.length === 0) {
                        return { status: 'no_db', list: [] };
                    }

                    const busy = new Set([...att.map(x => x.personnel_id), ...(lve || []).map(x => x.personnel_id)]);
                    return { status: 'ok', list: (allP || []).filter(p => !busy.has(p.personnel_id)) };
                };

                const initialData = await getAbsentList(selectedDate);

                const { value: f } = await Swal.fire({
                    title: '<span style="color:#ec4899; font-weight:bold;">‚úàÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</span>',
                    html: `
                        <div style="text-align:left; padding: 5px;">
                            <div style="margin-bottom:12px;">
                                <label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</label>
                                <input type="date" id="sw-date" class="swal2-input" style="border-radius:12px;" value="${selectedDate}">
                            </div>
                            <div style="margin-bottom:12px;">
                                <label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡πÑ‡∏°‡πà‡∏•‡∏≤)</label>
                                <select id="sw-pid" class="swal2-input" style="border-radius:12px;"></select>
                                <div id="sw-status-msg" style="font-size:0.75rem; margin-top:5px; display:none;"></div>
                            </div>
                            <div>
                                <label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                                <select id="sw-type" class="swal2-input" style="border-radius:12px;">
                                    ${leaveTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                        </div>`,
                    background: '#fef2f8', confirmButtonColor: '#ec4899', showCancelButton: true, reverseButtons: true,
                    didOpen: () => {
                        const dIn = document.getElementById('sw-date'), pSel = document.getElementById('sw-pid'), msg = document.getElementById('sw-status-msg');
                        const updateUI = (res) => {
                            if (res.status === 'no_db') {
                                pSel.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• --</option>';
                                pSel.disabled = true;
                                msg.style.display = 'block'; msg.style.color = '#ef4444'; msg.innerText = '‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
                            } else {
                                pSel.disabled = false; msg.style.display = 'none';
                                pSel.innerHTML = res.list.map(p => `<option value="${p.personnel_id}">${p.name}</option>`).join('') || '<option value="">-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß --</option>';
                            }
                        };
                        updateUI(initialData);
                        dIn.addEventListener('change', async () => {
                            pSel.innerHTML = '<option>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</option>';
                            const res = await getAbsentList(dIn.value);
                            updateUI(res);
                        });
                    },
                    preConfirm: () => {
                        const pid = document.getElementById('sw-pid').value;
                        if (!pid) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤'); return false; }
                        return { id: Date.now().toString(), personnel_id: pid, leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value, status: 'approved' };
                    }
                });
                if (f?.personnel_id) { await sbClient.from('Leave_records').insert([f]); render(); }
            } else if (currentTab === 'att') {
                let mode = 'in';
                const { value: f } = await Swal.fire({
                    title: '<span style="color:#ec4899; font-weight:bold;">üïí ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</span>',
                    html: `
                    <div style="text-align:left; padding: 5px;">
                        <div style="margin-bottom:15px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block; margin-bottom:5px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <div style="position:relative; margin-bottom:8px;">
                                <i class="fas fa-search" style="position:absolute; left:12px; top:13px; color:#d1d5db;"></i>
                                <input id="sw-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="swal2-input" style="margin:0; width:100%; padding-left:35px; border-radius:12px; font-size:0.95rem;">
                            </div>
                            <div style="border:1px solid #fbcfe8; border-radius:12px; overflow:hidden;">
                                <select id="sw-pid" size="5" style="width:100%; border:none; padding:5px;"></select>
                            </div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                            <input id="sw-date" type="date" class="swal2-input" style="margin:0; width:100%;" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block;">‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input id="sw-time" type="time" class="swal2-input" style="margin:0; width:100%; text-align:center; font-weight:bold;" value="${new Date().toTimeString().slice(0, 5)}">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="btn-in" style="flex:1; padding:12px; border-radius:10px; border:2px solid #10b981; background:#f0fdf4; color:#10b981; font-weight:bold; cursor:pointer;" onclick="window.setMode('in')">‡πÄ‡∏Ç‡πâ‡∏≤</button>
                            <button id="btn-out" style="flex:1; padding:12px; border-radius:10px; border:2px solid #e5e7eb; background:white; color:#9ca3af; font-weight:bold; cursor:pointer;" onclick="window.setMode('out')">‡∏≠‡∏≠‡∏Å</button>
                        </div>
                    </div>`,
                    didOpen: () => {
                        const search = document.getElementById('sw-search'), select = document.getElementById('sw-pid');
                        const update = (term = "") => {
                            const filtered = personnelList.filter(p => p.name.includes(term));
                            select.innerHTML = filtered.map(p => `<option value="${p.personnel_id}" style="padding:8px;">${p.name}</option>`).join('');
                            if (filtered.length) select.selectedIndex = 0;
                        };
                        search.addEventListener('input', (e) => update(e.target.value)); update();
                        window.setMode = (m) => {
                            mode = m;
                            const bin = document.getElementById('btn-in'), bout = document.getElementById('btn-out');
                            if (m === 'in') { bin.style.background = '#f0fdf4'; bin.style.borderColor = '#10b981'; bin.style.color = '#10b981'; bout.style.background = 'white'; bout.style.borderColor = '#e5e7eb'; bout.style.color = '#9ca3af'; }
                            else { bout.style.background = '#fef2f2'; bout.style.borderColor = '#ef4444'; bout.style.color = '#ef4444'; bin.style.background = 'white'; bin.style.borderColor = '#e5e7eb'; bin.style.color = '#9ca3af'; }
                        };
                    },
                    preConfirm: () => {
                        const pid = document.getElementById('sw-pid').value, date = document.getElementById('sw-date').value, time = document.getElementById('sw-time').value;
                        if (!pid) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                        const res = { id: `${date.replace(/-/g, '')}${pid}`, personnel_id: pid, full_name: personnelMap[pid], work_date: date, verified: 0 };
                        res[mode === 'in' ? 'time_in' : 'time_out'] = time + ":00";
                        return res;
                    }
                });
                if (f) { await sbClient.from('TimeStamp').upsert([f], { onConflict: 'personnel_id, work_date' }); render(); }
            }
        }
    </script>
</body>

</html>