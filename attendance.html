<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ (Level 1) - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #3b82f6; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; background: #f1f5f9; padding: 8px 15px; border-radius: 20px; transition: 0.2s; }
        .back-btn:hover { background: #cbd5e1; color: #0f172a; }

        /* Toolbar */
        .toolbar { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: end; background: #f1f5f9; padding: 15px; border-radius: 8px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #475569; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: 'Sarabun'; font-size: 1rem; }
        
        /* Buttons */
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-family: 'Sarabun'; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        
        /* Action Buttons (Small) */
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; border-radius: 4px; }
        
        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #e2e8f0; color: #334155; font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f8fafc; }
        td input { width: 100px; padding: 5px; font-size: 0.9rem; }

        /* Modal */
        .modal-form { display: grid; gap: 15px; text-align: left; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (TimeStampPlus)</h2>
            <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="toolbar">
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate">
            </div>
            <button class="btn btn-primary" onclick="loadData()">
                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <div style="flex-grow: 1;"></div>
            <button class="btn btn-success" onclick="openAddModal()">
                <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <div class="table-responsive">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th width="15%">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                        <th width="25%">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th width="15%">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th width="15%">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                        <th width="15%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th width="15%" style="text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Level 1
        const user = checkAuth(); // ‡∏à‡∏≤‡∏Å config.js
        
        // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            loadData();
        });

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const tbody = document.getElementById('tableBody');
            
            if(!date) return;

            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

            // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å TimeStampPlus
            const { data, error } = await sbClient
                .from(TAS_CONFIG.TABLE_SOURCE) // ‡πÉ‡∏ä‡πâ TimeStampPlus
                .select('*')
                .eq('work_date', date)
                .order('time_in', { ascending: true });

            if (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center;">Error: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateThai(date)}</td></tr>`;
                return;
            }

            let html = '';
            data.forEach(row => {
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà HH:MM
                const tIn = row.time_in ? row.time_in.substring(0, 5) : ''; 
                const tOut = row.time_out ? row.time_out.substring(0, 5) : '';

                html += `
                    <tr>
                        <td>${row.personnel_id || '-'}</td>
                        <td>${row.full_name || '-'}</td>
                        <td>${tIn}</td>
                        <td>${tOut}</td>
                        <td>${formatDateThai(row.work_date)}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-warning btn-sm" onclick="openEditModal('${row.id}', '${row.personnel_id}', '${row.full_name}', '${tIn}', '${tOut}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('${row.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Add)
        async function openAddModal() {
            const currentDate = document.getElementById('filterDate').value;
            
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Manual)',
                html: `
                    <div class="modal-form">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <input id="swal-pid" class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10043"></label>
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: <input id="swal-name" class="swal2-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"></label>
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <input type="date" id="swal-date" class="swal2-input" value="${currentDate}"></label>
                        <div style="display:flex; gap:10px;">
                            <label style="flex:1">‡πÄ‡∏Ç‡πâ‡∏≤: <input type="time" id="swal-in" class="swal2-input"></label>
                            <label style="flex:1">‡∏≠‡∏≠‡∏Å: <input type="time" id="swal-out" class="swal2-input"></label>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    return {
                        pid: document.getElementById('swal-pid').value,
                        name: document.getElementById('swal-name').value,
                        date: document.getElementById('swal-date').value,
                        in: document.getElementById('swal-in').value,
                        out: document.getElementById('swal-out').value
                    }
                }
            });

            if (formValues) {
                if(!formValues.pid || !formValues.date) {
                    Swal.fire('Error', '‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                    return;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° 18 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ)
                const newID = generateLongID(); 

                const { error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE)
                    .insert([{
                        id: newID,
                        personnel_id: formValues.pid,
                        full_name: formValues.name,
                        work_date: formValues.date,
                        time_in: formValues.in || null,
                        time_out: formValues.out || null
                    }]);

                if(error) Swal.fire('Error', error.message, 'error');
                else {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    loadData();
                }
            }
        }

        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit)
        async function openEditModal(id, pid, name, tIn, tOut) {
            const { value: formValues } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤: ${name} (${pid})`,
                html: `
                    <div class="modal-form">
                        <div style="display:flex; gap:10px;">
                            <label style="flex:1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤: <input type="time" id="edit-in" class="swal2-input" value="${tIn}"></label>
                            <label style="flex:1">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: <input type="time" id="edit-out" class="swal2-input" value="${tOut}"></label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
                preConfirm: () => {
                    return {
                        in: document.getElementById('edit-in').value,
                        out: document.getElementById('edit-out').value
                    }
                }
            });

            if (formValues) {
                const { error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE)
                    .update({ 
                        time_in: formValues.in || null,
                        time_out: formValues.out || null 
                    })
                    .eq('id', id); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° ID (Primary Key)

                if(error) Swal.fire('Error', error.message, 'error');
                else {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    loadData();
                }
            }
        }

        // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Delete)
        function deleteRecord(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö TimeStampPlus",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await sbClient
                        .from(TAS_CONFIG.TABLE_SOURCE)
                        .delete()
                        .eq('id', id);

                    if(error) Swal.fire('Error', error.message, 'error');
                    else {
                        loadData();
                        Swal.fire('Deleted!', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    }
                }
            })
        }

        // Helpers
        function formatDateThai(dateStr) {
            if(!dateStr) return "-";
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear() + 543}`;
        }

        function generateLongID() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID 18 ‡∏´‡∏•‡∏±‡∏Å: YYYYMMDDHHmmssRRRR
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}${r}`;
        }
    </script>
</body>
</html>
