<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ (Level 1) - TAS-SPB</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-primary { background: #3b82f6; } .btn-success { background: #10b981; } .btn-warning { background: #f59e0b; } .btn-danger { background: #ef4444; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #e2e8f0; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>

<div class="container">
    <h2>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (TimeStampPlus)</h2>
    
    <div class="toolbar">
        <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="filterDate">
        </div>
        <button class="btn btn-primary" onclick="loadData()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="btn btn-success" onclick="openAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <a href="menu.html" style="margin-left:auto;" class="btn btn-warning">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th>‡∏≠‡∏≠‡∏Å</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody id="tableBody"><tr><td colspan="5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr></tbody>
    </table>
</div>

<script>
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö
    if(typeof sbClient === 'undefined') {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå config.js");
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function loadData() {
        const date = document.getElementById('filterDate').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="5">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

        try {
            console.log("Fetching from:", TAS_CONFIG.TABLE_SOURCE, "Date:", date);
            
            const { data, error } = await sbClient
                .from(TAS_CONFIG.TABLE_SOURCE)
                .select('*')
                .eq('work_date', date)
                .order('time_in', { ascending: true });

            if (error) throw error;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }

            let html = '';
            data.forEach(row => {
                const tIn = row.time_in ? row.time_in.substring(0, 5) : '';
                const tOut = row.time_out ? row.time_out.substring(0, 5) : '';
                html += `
                    <tr>
                        <td>${row.personnel_id}</td>
                        <td>${row.full_name}</td>
                        <td>${tIn}</td>
                        <td>${tOut}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editData('${row.id}', '${tIn}', '${tOut}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="delData('${row.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
            tbody.innerHTML = html;

        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="5" style="color:red">‚ùå Error: ${err.message}</td></tr>`;
        }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function openAddModal() {
        const { value: f } = await Swal.fire({
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà',
            html: `
                <input id="swal-pid" class="swal2-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                <input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
                <input type="time" id="swal-in" class="swal2-input">
                <input type="time" id="swal-out" class="swal2-input">
            `,
            preConfirm: () => ({
                pid: document.getElementById('swal-pid').value,
                name: document.getElementById('swal-name').value,
                in: document.getElementById('swal-in').value,
                out: document.getElementById('swal-out').value
            })
        });

        if (f) {
            if(!f.pid) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");

            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (YYYYMMDDHHmmSS + Random)
                const d = new Date();
                const newId = d.toISOString().replace(/[-:T.]/g, '').slice(0,14) + Math.floor(Math.random()*1000);
                const wDate = document.getElementById('filterDate').value;

                console.log("Saving...", { newId, ...f, wDate });

                const { error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE)
                    .insert([{
                        id: newId,
                        personnel_id: f.pid,
                        full_name: f.name,
                        work_date: wDate,
                        time_in: f.in || null,
                        time_out: f.out || null
                    }]);

                if (error) throw error;
                
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
                loadData();
            } catch (err) {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
                console.error(err);
            }
        }
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function editData(id, oldIn, oldOut) {
        const { value: f } = await Swal.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤',
            html: `
                ‡πÄ‡∏Ç‡πâ‡∏≤: <input type="time" id="edit-in" class="swal2-input" value="${oldIn}"><br>
                ‡∏≠‡∏≠‡∏Å: <input type="time" id="edit-out" class="swal2-input" value="${oldOut}">
            `,
            preConfirm: () => ({
                in: document.getElementById('edit-in').value,
                out: document.getElementById('edit-out').value
            })
        });

        if (f) {
            try {
                const { error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE)
                    .update({ time_in: f.in || null, time_out: f.out || null })
                    .eq('id', id);

                if (error) throw error;
                Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                loadData();
            } catch (err) {
                alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
            }
        }
    }

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function delData(id) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
        try {
            const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE).delete().eq('id', id);
            if (error) throw error;
            loadData();
        } catch (err) {
            alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
        }
    }
</script>
</body>
</html>
