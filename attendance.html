<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö - TAS-SPB</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="ios-fix.js"></script>

    <style>
        :root {
            --primary-color: #ec4899;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            padding-bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { max-width: 1000px; margin: 0 auto; width: 100%; }

        /* Header */
        .header-section {
            background: white;
            width: 100%;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header-title { display: flex; align-items: center; gap: 15px; }
        .icon-box {
            width: 50px; height: 50px; background: var(--primary-color);
            color: white; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .header-text h2 { margin: 0; color: #1f2937; font-size: 1.5rem; }
        .header-text span { color: #6b7280; font-size: 0.9rem; }

        .btn-home {
            text-decoration: none; color: #4b5563; font-weight: bold;
            background: #f3f4f6; padding: 8px 16px; border-radius: 20px;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-home:hover { background: #e5e7eb; }

        /* Controls */
        .controls-card {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .date-input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 10px; font-family: 'Sarabun'; font-size: 1rem;
            background: #f9fafb;
        }

        .filter-status { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-filter {
            padding: 8px 16px; border-radius: 10px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; border: 1px solid transparent;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-filter.active { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        .search-box-container {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Tabs */
        .tabs {
            display: flex; background: #e5e7eb; padding: 5px;
            border-radius: 12px; flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            color: var(--muted); font-family: 'Sarabun'; transition: all 0.2s;
            min-width: 100px;
        }
        .tab-btn.active {
            background: var(--white); color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-section { display: none; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Items */
        .data-list { display: grid; gap: 15px; }
        .data-item {
            background: var(--white); padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-left: 5px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
        }

        .item-att { border-left-color: var(--primary-color); }
        .item-leave { border-left-color: var(--warning); }
        .item-personnel { border-left-color: var(--info); }

        .info h4 { margin: 0; font-size: 1rem; }
        .info p {
            margin: 5px 0 0; font-size: 0.85rem; color: var(--muted);
            display: flex; gap: 8px; flex-wrap: wrap;
        }

        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-red { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-orange { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .bg-blue { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        .actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 36px; height: 36px; border-radius: 8px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-edit { background: #fffbeb; color: #d97706; }
        .btn-del { background: #fef2f2; color: #dc2626; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-top: 20px; padding: 10px;
        }
        .btn-page {
            padding: 8px 16px; border-radius: 12px; border: none;
            background: white; color: var(--text); font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex; align-items: center; gap: 5px;
        }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }

        .fab {
            position: fixed; bottom: 20px; right: 20px; background: var(--success);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            cursor: pointer; border: none; z-index: 100;
        }

        @media (max-width: 600px) {
            .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn-home { align-self: flex-start; }
            .data-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .actions { width: 100%; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }
            .search-box-container { flex-direction: column; }
        }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>

<body>
    <div class="container">
        <div class="header-section">
            <div class="header-title">
                <div class="icon-box"><i class="fas fa-calendar-check"></i></div>
                <div class="header-text">
                    <h2 id="pageTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <span id="pageSubTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</span>
                </div>
            </div>
            <a href="menu.html" class="btn-home">
                <i class="fas fa-home"></i> ‡πÄ‡∏°‡∏ô‡∏π
            </a>
        </div>

        <div class="controls-card">
            <div id="date-control-group">
                <label style="font-weight:bold; color:#6b7280;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate" class="date-input" onchange="loadAttendance()">
            </div>
            <div class="tabs">
                <button id="btn-tab-att" class="tab-btn active" onclick="switchTab('att')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                <button id="btn-tab-leave" class="tab-btn" onclick="switchTab('leave')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                <button id="btn-tab-personnel" class="tab-btn" onclick="switchTab('personnel')" style="display:none;">üë• ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
            </div>
        </div>

        <div id="tab-att" class="content-section active">
            <div id="filter-container" class="filter-status" style="display:none;">
                <button id="filter-all" class="btn-filter bg-green active" onclick="setStatusFilter('all')">
                    <i class="fas fa-list"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button id="filter-incomplete" class="btn-filter bg-gray" onclick="setStatusFilter('incomplete')">
                    <i class="fas fa-exclamation-triangle"></i> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                </button>
            </div>
            <div id="list-att" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="tab-leave" class="content-section">
            <div class="search-box-container">
                <div style="flex: 2; min-width: 200px;">
                    <input type="text" id="leave-search-name" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="if(event.key==='Enter') searchLeave()">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <input type="date" id="leave-search-date" class="date-input">
                </div>
                <button class="btn-filter bg-green" onclick="searchLeave()" style="color: #166534; background-color: #dcfce7; border: 1px solid #bbf7d0;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearLeaveFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-leave" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="leave-prev-btn" class="btn-page" onclick="changeLeavePage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="leave-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="leave-next-btn" class="btn-page" onclick="changeLeavePage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="tab-personnel" class="content-section">
            <div class="search-box-container">
                <div style="flex: 1;">
                    <input type="text" id="personnel-search" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." onkeyup="if(event.key==='Enter') searchPersonnel()">
                </div>
                <button class="btn-filter bg-blue" onclick="searchPersonnel()" style="color: #1e40af; background-color: #dbeafe; border: 1px solid #bfdbfe;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearPersonnelFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-personnel" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="personnel-prev-btn" class="btn-page" onclick="changePersonnelPage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="personnel-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="personnel-next-btn" class="btn-page" onclick="changePersonnelPage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <button class="fab" onclick="handleAddClick()"><i class="fas fa-plus"></i></button>

    <script>
        // ==========================================
        // Security Check
        // ==========================================
        const storedUser = localStorage.getItem('tas_user');
        if (!storedUser) { window.location.href = 'login.html'; }

        const user = JSON.parse(storedUser);
        const userLevel = String(user.level || '').trim();

        if (userLevel !== '1' && userLevel !== '2') {
            document.body.style.display = 'none';
            setTimeout(() => {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ',
                    text: `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ`,
                    confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π'
                }).then(() => { window.location.replace('menu.html'); });
            }, 100);
            throw new Error("Unauthorized Access");
        }

        if (typeof sbClient === 'undefined') Swal.fire('Error', 'Supabase Client Not Found', 'error');

        // Global State
        let currentTab = 'att';
        let statusFilter = 'all';
        let personnelMap = {};
        let leaveTypes = [];

        // Pagination Vars
        let leavePage = 0;
        const LEAVE_PER_PAGE = 10;
        
        let personnelPage = 0;
        const PERSONNEL_PER_PAGE = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            const dateInput = document.getElementById('filterDate');
            if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            
            await loadMasterData();

            // Set Title & Subtitle based on User Level
            if (userLevel === '2') {
                // Level 2: Default to Leave tab, Hide Attendance
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£"; // [NEW]
                document.getElementById('btn-tab-att').style.display = 'none';
                document.getElementById('btn-tab-personnel').style.display = 'block';
                switchTab('leave');
            } else {
                // Level 1: Default to Attendance
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£"; // [NEW]
                document.getElementById('btn-tab-personnel').style.display = 'block';
                loadAttendance();
            }
        });

        window.switchTab = function (tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-tab-${tabName}`);
            if (btn) btn.classList.add('active');

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            const dateControl = document.getElementById('date-control-group');
            document.getElementById('filter-container').style.display = 'none';
            
            if (tabName === 'att') {
                if (dateControl) dateControl.style.display = 'block';
                loadAttendance();
            } else if (tabName === 'leave') {
                if (dateControl) dateControl.style.display = 'none';
                loadLeaves();
            } else if (tabName === 'personnel') {
                if (dateControl) dateControl.style.display = 'none';
                loadPersonnel();
            }
        }

        async function loadMasterData() {
            try {
                const { data: users } = await sbClient.from('Personnel').select('personnel_id, name');
                if (users) users.forEach(u => personnelMap[u.personnel_id] = u.name);
                const { data: settings } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('value').eq('key', 'leave_types').single();
                leaveTypes = (settings && settings.value) ? settings.value.split(',') : ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
            } catch (e) { console.error(e); }
        }

        // ==========================================
        // Tab 1: Attendance
        // ==========================================
        window.setStatusFilter = function (status) {
            statusFilter = status;
            const btnAll = document.getElementById('filter-all');
            const btnInc = document.getElementById('
