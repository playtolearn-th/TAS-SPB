<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡πà‡∏≠) */
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .nav-bar { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .back-btn { background: white; color: #4338ca; border: 1px solid #e0e7ff; padding: 8px 15px; border-radius: 20px; cursor: pointer; text-decoration: none; font-weight: bold; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 400px; text-align: center; }
        .clock { font-size: 3.5rem; font-family: monospace; font-weight: bold; color: #2563eb; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 15px; font-weight: bold; color: white; cursor: pointer; }
        .btn-in { background: #22c55e; } .btn-out { background: #f97316; }
        .status-row { display: flex; justify-content: space-between; margin-top: 1rem; background: #f9fafb; padding: 10px; border-radius: 10px; }
        .btn-edit { background: white; border: 1px solid #ddd; padding: 2px 8px; cursor: pointer; border-radius: 5px; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script> </head>
<body>
    <div class="nav-bar">
        <a href="menu.html" class="back-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        <div>üë§ <span id="userName">...</span></div>
    </div>

    <div class="card">
        <div id="humanDate">-</div>
        <div class="clock" id="clockDisplay">00:00:00</div>

        <div class="btn-group">
            <button class="btn btn-in" onclick="recordTime('in')">üïí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-out" onclick="recordTime('out')">üè† ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div style="margin-top: 20px; text-align: left;">
            <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b>
            <div class="status-row">
                <span>‡πÄ‡∏Ç‡πâ‡∏≤: <span id="timeInDisplay">-</span></span>
                <button class="btn-edit" onclick="editTime('time_in')">‚úèÔ∏è</button>
            </div>
            <div class="status-row">
                <span>‡∏≠‡∏≠‡∏Å: <span id="timeOutDisplay">-</span></span>
                <button class="btn-edit" onclick="editTime('time_out')">‚úèÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        const user = checkAuth();
        let currentRecord = null;
        
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });

        if(user) {
            document.getElementById('userName').innerText = user.name;
            startClock();
            loadTodayRecord();
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
                document.getElementById('humanDate').innerText = now.toLocaleDateString('th-TH');
            }, 1000);
        }

        async function loadTodayRecord() {
            const today = getDBDateString();
            const { data } = await sbClient.from(TAS_CONFIG.TABLE_TIME)
                .select('*').eq('personnel_id', user.personnel_id).eq('work_date', today).single();
            
            if (data) {
                currentRecord = data;
                document.getElementById('timeInDisplay').innerText = data.time_in || "-";
                document.getElementById('timeOutDisplay').innerText = data.time_out || "-";
            } else {
                currentRecord = null;
                document.getElementById('timeInDisplay').innerText = "-";
                document.getElementById('timeOutDisplay').innerText = "-";
            }
        }

        async function recordTime(type) {
            if(!await confirmAction(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type=='in'?'‡πÄ‡∏Ç‡πâ‡∏≤':'‡∏≠‡∏≠‡∏Å'}?`)) return;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
            const today = getDBDateString();
            const newID = generateID();

            let error = null;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            await loadTodayRecord();

            if (type === 'in') {
                if (currentRecord) {
                    const { error: e } = await sbClient.from(TAS_CONFIG.TABLE_TIME).update({ time_in: timeStr }).eq('id', currentRecord.id);
                    error = e;
                } else {
                    const { error: e } = await sbClient.from(TAS_CONFIG.TABLE_TIME).insert([{
                        id: newID, personnel_id: user.personnel_id, full_name: user.name, work_date: today, time_in: timeStr
                    }]);
                    error = e;
                }
            } else {
                if (currentRecord) {
                    const { error: e } = await sbClient.from(TAS_CONFIG.TABLE_TIME).update({ time_out: timeStr }).eq('id', currentRecord.id);
                    error = e;
                } else {
                    const { error: e } = await sbClient.from(TAS_CONFIG.TABLE_TIME).insert([{
                        id: newID, personnel_id: user.personnel_id, full_name: user.name, work_date: today, time_out: timeStr
                    }]);
                    error = e;
                }
            }

            if(error) Swal.fire('Error', error.message, 'error');
            else { Toast.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' }); loadTodayRecord(); }
        }

        async function editTime(field) {
            if(!currentRecord) return Swal.fire('Warn', '‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ', 'warning');
            
            const { value: newVal } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤', input: 'time', inputLabel: 'HH:MM:SS',
                inputValue: field==='time_in' ? currentRecord.time_in : currentRecord.time_out,
                inputAttributes: { step: 1 }, showCancelButton: true
            });

            if(newVal) {
                const timeToSave = newVal.length === 5 ? newVal+":00" : newVal;
                await sbClient.from(TAS_CONFIG.TABLE_TIME).update({ [field]: timeToSave }).eq('id', currentRecord.id);
                Toast.fire({ icon: 'success', title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
                loadTodayRecord();
            }
        }

        async function confirmAction(text) {
            const res = await Swal.fire({ title: text, icon: 'question', showCancelButton: true, confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
            return res.isConfirmed;
        }
    </script>
</body>
</html>
