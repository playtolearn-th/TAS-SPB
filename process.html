<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏ß‡∏•‡∏≤ - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .btn-process { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 20px 0; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); transition: transform 0.2s; }
        .btn-process:active { transform: scale(0.95); }
        .btn-process:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .log-box { text-align: left; background: #1e293b; color: #10b981; border-radius: 10px; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #e2e8f0; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; display: inline-block; margin-bottom: 20px; }
        .highlight { color: #fbbf24; } 
        .error { color: #ef4444; } 
    </style>
    
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

    <div class="container">
        <h2>üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Auto Sync)</h2>
        <p>‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÅ‡∏ö‡∏ö: <b>DDMMYYYY + ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</b><br>‡πÄ‡∏ä‡πà‡∏ô <i>3012202510043</i></p>
        
        <button id="btnStart" class="btn-process" onclick="startProcess()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
        
        <div class="log-box" id="logDisplay">
            > ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...
        </div>
    </div>

    <script>
        const user = checkAuth();

        function log(msg, type = 'normal') {
            const box = document.getElementById('logDisplay');
            let colorClass = '';
            if(type === 'highlight') colorClass = 'class="highlight"';
            if(type === 'error') colorClass = 'class="error"';
            
            box.innerHTML += `<div ${colorClass}>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // ‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö DB Work Date)
        function formatDateDB(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
        }

        // ‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô DDMMYYYY (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL ‡πÅ‡∏•‡∏∞ ID)
        function formatDateID(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(date.getDate())}${pad(date.getMonth() + 1)}${date.getFullYear()}`;
        }

        async function startProcess() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('logDisplay').innerHTML = '<div>> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...</div>';

            try {
                // 1. ‡∏î‡∏∂‡∏á Base URL
                const { data: settingData } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS)
                    .select('value').eq('key', 'data_url').single();
                
                let baseURL = "";
                if (settingData && settingData.value) {
                    baseURL = settingData.value.endsWith('/') ? settingData.value : settingData.value + '/';
                    log(`Base URL: ${baseURL}`);
                } else {
                    log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö data_url ‡πÉ‡∏ô Settings (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏≠‡∏Å)`);
                }

                // 2. ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...");
                const { data: latestRecord } = await sbClient
                    .from(TAS_CONFIG.TABLE_TARGET)
                    .select('work_date')
                    .order('work_date', { ascending: false })
                    .limit(1)
                    .single();

                let startDate = new Date();
                if (latestRecord && latestRecord.work_date) {
                    startDate = new Date(latestRecord.work_date);
                    log(`üìÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateDB(startDate)}`, 'highlight');
                } else {
                    log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'");
                }

                // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ
                const today = new Date();
                today.setHours(0,0,0,0);
                startDate.setHours(0,0,0,0);
                let loopDate = new Date(startDate); 

                while (loopDate <= today) {
                    const dateDBStr = formatDateDB(loopDate);   // 2025-12-30
                    const dateIDStr = formatDateID(loopDate);   // 30122025
                    
                    log(`-----------------------------------`);
                    log(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateDBStr}...`, 'highlight');

                    // 3.1 ‡∏î‡∏∂‡∏á Web ‡∏ô‡∏≠‡∏Å
                    let externalData = [];
                    if (baseURL) {
                        try {
                            const res = await fetch(`${baseURL}${dateIDStr}`);
                            if (res.ok) {
                                externalData = await res.json();
                                log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å: ‡∏û‡∏ö ${externalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                            } else {
                                log(`   ‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Status: ${res.status})`);
                            }
                        } catch (e) {
                            log(`   ‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ç‡πâ‡∏≤‡∏°)`, 'error');
                        }
                    }

                    // 3.2 ‡∏î‡∏∂‡∏á DB ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
                    const { data: internalData, error: errInt } = await sbClient
                        .from(TAS_CONFIG.TABLE_SOURCE)
                        .select('*')
                        .eq('work_date', dateDBStr);

                    if (errInt) log(`   ‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${errInt.message}`, 'error');
                    else log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Web): ‡∏û‡∏ö ${internalData ? internalData.length : 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                    // 3.3 ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Merge)
                    const mergedMap = {};
                    const processRecord = (rec) => {
                        const pid = rec.personnel_id;
                        if (!mergedMap[pid]) {
                            mergedMap[pid] = {
                                personnel_id: pid,
                                full_name: rec.full_name || rec.name,
                                work_date: dateDBStr,
                                time_in: rec.time_in,
                                time_out: rec.time_out
                            };
                        } else {
                            const current = mergedMap[pid];
                            if (rec.time_in && (!current.time_in || rec.time_in < current.time_in)) current.time_in = rec.time_in;
                            if (rec.time_out && (!current.time_out || rec.time_out > current.time_out)) current.time_out = rec.time_out;
                        }
                    };

                    if (externalData.length > 0) externalData.forEach(processRecord);
                    if (internalData && internalData.length > 0) internalData.forEach(processRecord);

                    const finalData = Object.values(mergedMap);

                    // 3.4 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Generate ID ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà!)
                    if (finalData.length > 0) {
                        const recordsToSave = finalData.map(item => ({
                            // üî•üî•üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏™‡∏£‡πâ‡∏≤‡∏á ID = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà+‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô üî•üî•üî•
                            id: `${dateIDStr}${item.personnel_id}`, 
                            
                            personnel_id: item.personnel_id,
                            full_name: item.full_name,
                            work_date: item.work_date,
                            time_in: item.time_in,
                            time_out: item.time_out,
                            verified: 0
                        }));

                        // ‡πÉ‡∏ä‡πâ Upsert (‡∏ñ‡πâ‡∏≤ ID ‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠ personnel_id+work_date ‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö)
                        const { error: errUpsert } = await sbClient
                            .from(TAS_CONFIG.TABLE_TARGET)
                            .upsert(recordsToSave, { onConflict: 'personnel_id, work_date' });

                        if (errUpsert) log(`   ‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errUpsert.message}`, 'error');
                        else log(`   üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${recordsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                    } else {
                        log(`   (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`);
                    }

                    loopDate.setDate(loopDate.getDate() + 1);
                }

                log(`-----------------------------------`);
                log(`‚úÖ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!`, 'highlight');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');

            } catch (err) {
                console.error(err);
                log(`‚ùå Error: ${err.message}`, 'error');
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
